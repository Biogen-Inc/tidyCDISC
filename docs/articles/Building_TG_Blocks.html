<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create A Statistical Block • tidyCDISC</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Create A Statistical Block">
<meta property="og:description" content="tidyCDISC">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tidyCDISC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Building_TG_Blocks.html">Create A Statistical Block</a>
    </li>
    <li>
      <a href="../articles/Create_TG_Table.html">Creating Tables</a>
    </li>
    <li>
      <a href="../articles/User_Guide_Indv_Expl.html">Users Guide to the Individual Explorer Tab</a>
    </li>
    <li>
      <a href="../articles/dev_Indv_Expl_Add_Events.html">Integrate New Events in Individual Explorer</a>
    </li>
    <li>
      <a href="../articles/dev_popExp_add_graph.html">Add a Graph to the Population Explorer</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MayaGans/tidyCDISC/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Create A Statistical Block</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/MayaGans/tidyCDISC/blob/master/vignettes/Building_TG_Blocks.Rmd"><code>vignettes/Building_TG_Blocks.Rmd</code></a></small>
      <div class="hidden name"><code>Building_TG_Blocks.Rmd</code></div>

    </div>

    
    
<p>This tutorial will walk you through creating a new statistical block using JavaScript and R, then writing an R function to use the block within the <code>gt</code> table.</p>
<div id="creating-blocks" class="section level1">
<h1 class="hasAnchor">
<a href="#creating-blocks" class="anchor"></a>Creating Blocks</h1>
<p>To create a new statistical block for the Table Generator takes a combination of R and a little bit of JavaScript:</p>
<div id="create-the-drag-zone-block" class="section level3">
<h3 class="hasAnchor">
<a href="#create-the-drag-zone-block" class="anchor"></a>Create the Drag Zone Block</h3>
<p>Within <code>R/mod_TableGen_ui</code> you’ll find a list of blocks.</p>
<p>If you are going to create a simple block like in the case of <code>MEAN</code>, you’ll give the block an id in lowecase, and a label to be displayed in uppercase. You must also give the block <code>class = agg</code></p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">tags</span>$<span class="fu">li</span>(<span class="kw">id</span> <span class="kw">=</span> <span class="st">"mean"</span>,<span class="st">"MEAN"</span>,<span class="kw">class</span> <span class="kw">=</span> <span class="st">"agg"</span>)</pre></body></html></div>
<p>If you want to create a more complicated block that changes within the drop zone, or has hover text there are a couple more arguments you must add:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">tags</span>$<span class="fu">li</span>(<span class="kw">class</span> <span class="kw">=</span> <span class="st">"ui-state-default agg"</span>, <span class="kw">id</span> <span class="kw">=</span> <span class="st">"chg"</span>,
        <span class="fu">div</span>(<span class="fu">tippy</span>(<span class="fu">div</span>(<span class="st">"CHG"</span>), <span class="st">"Change from Baseline"</span>)))</pre></body></html></div>
<ul>
<li>an additional <code>ui-state-default</code> class</li>
<li>another div using the package <code>tippy</code> to create the text to display <code>CHG</code> and the hover text</li>
</ul>
</div>
<div id="create-the-drop-zone-block" class="section level3">
<h3 class="hasAnchor">
<a href="#create-the-drop-zone-block" class="anchor"></a>Create the Drop Zone Block</h3>
<p>Under <code>www/inst</code> you will find the <code>script.js</code> file which describes the HTML for a block within the drag zone.</p>
<p>Currently there are two JavaScript functions to create HTML blocks</p>
<ul>
<li><p><code>simpleBlock</code> which creates a block like the <code>FREQ</code> block which says “FREQ” when dragged and has a delete button</p></li>
<li><p><code>selectWeekBlock</code> which creates a dropdown when the block is dragged into the drop zone, determined by the unique values in the <code>AVISIT</code> column</p></li>
</ul>
<p>You can add your block to the function <code>$("#droppable_agg").droppable(...</code> like so:</p>
<pre><code>} else if (draggableId.includes("mean")) {
    $(this).append(selectWeekBlock(newid, "MEAN", select));
}</code></pre>
<p>Where the lowecase <code>mean</code> corresponds to the ID of the block, and <code>new_id</code> is a JavaScript function that appends a number to your block ID in case there are multiple <code>mean</code> blocks inside the dropzone. The uppercase <code>MEAN</code> is what you want your block to display. Similarly you can change this code from <code>selectWeekBlock</code> to a simple block if you don’t need the week dropdown.</p>
</div>
<div id="writing-the-function" class="section level3">
<h3 class="hasAnchor">
<a href="#writing-the-function" class="anchor"></a>Writing the function</h3>
<p>When you drag a column block, the shiny input returns the name of the column and the data file it came from. Using the <code>custom_class</code> function, the column name is given a class of <code>BDS</code>, <code>ADSL</code>, or <code>OCCDS</code></p>
<p>We can leverage these classes when creating a new statistical function because we may want to perform slightly different calculations on an ADSL or BDS, for instance.</p>
<p>Let’s look at <code>mod_tableGen_fct_freq</code> as an example:</p>
</div>
<div id="create-a-function" class="section level3">
<h3 class="hasAnchor">
<a href="#create-a-function" class="anchor"></a>Create a function</h3>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">CDISC_freq</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">column</span>, <span class="no">week</span>, <span class="no">group</span>, <span class="no">data</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/UseMethod.html">UseMethod</a></span>(<span class="st">"CDISC_freq"</span>, <span class="no">column</span>)
}


<span class="no">CDISC_freq.default</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">column</span>, <span class="no">week</span>, <span class="no">group</span>, <span class="no">data</span>) {
  <span class="kw pkg">rlang</span><span class="kw ns">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span>(<span class="kw pkg">glue</span><span class="kw ns">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(
    <span class="st">"Can't calculate mean because data is not classified as ADLB, BDS or OCCDS"</span>
  ))
}</pre></body></html></div>
</div>
<div id="create-a-method-for-adsl" class="section level3">
<h3 class="hasAnchor">
<a href="#create-a-method-for-adsl" class="anchor"></a>Create a method for ADSL</h3>
<p>In the case of ADSL we need to calculate the frequency for the entire table, or if groups are selected and return a table of values to be used in gt.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">CDISC_freq.ADSL</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">column</span>, <span class="no">week</span>, <span class="no">group</span> <span class="kw">=</span> <span class="kw">NULL</span>, <span class="no">data</span>) {

  <span class="no">column</span> <span class="kw">&lt;-</span> <span class="kw pkg">rlang</span><span class="kw ns">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html">sym</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">column</span>))

  <span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span>(<span class="no">data</span><span class="kw">[[</span><span class="no">column</span>]])) {
    <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Can't calculate frequency, "</span>, <span class="no">column</span>, <span class="st">" is not categorical"</span>))
  }

  <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">group</span>)) {
    <span class="no">data</span> <span class="kw">%&gt;%</span>
      <span class="fu">distinct</span>(<span class="no">USUBJID</span>, !!<span class="no">column</span>) <span class="kw">%&gt;%</span>
      <span class="fu">count</span>(!!<span class="no">column</span>) <span class="kw">%&gt;%</span>
      <span class="fu">group_by</span>(!!<span class="no">column</span>) <span class="kw">%&gt;%</span>
      <span class="fu">summarise</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">n</span>)) <span class="kw">%&gt;%</span>
      <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">prop</span> <span class="kw">=</span> <span class="no">n</span>/<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">n</span>)) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">n</span>, <span class="st">" ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">prop</span>*<span class="fl">100</span>, <span class="fl">2</span>), <span class="st">")"</span>)) <span class="kw">%&gt;%</span>
      <span class="fu">select</span>(!!<span class="no">column</span>, <span class="no">x</span>)
  } <span class="kw">else</span> {

    <span class="kw">if</span> (<span class="no">group</span> <span class="kw">==</span> <span class="no">column</span>) {
      <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="kw pkg">glue</span><span class="kw ns">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"Cannot calculate frequency for {column} when also set as group."</span>))
    }

    <span class="no">group</span> <span class="kw">&lt;-</span> <span class="kw pkg">rlang</span><span class="kw ns">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html">sym</a></span>(<span class="no">group</span>)
    <span class="no">data</span> <span class="kw">%&gt;%</span>
      <span class="fu">distinct</span>(<span class="no">USUBJID</span>, !!<span class="no">column</span>, !!<span class="no">group</span>) <span class="kw">%&gt;%</span>
      <span class="fu">count</span>(!!<span class="no">column</span>, !!<span class="no">group</span>) <span class="kw">%&gt;%</span>
      <span class="fu">group_by</span>(!!<span class="no">group</span>) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">prop</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/prop.table.html">prop.table</a></span>(<span class="no">n</span>)) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">v1</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">n</span>, <span class="st">' ('</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">prop</span>*<span class="fl">100</span>, <span class="fl">2</span>), <span class="st">')'</span>)) <span class="kw">%&gt;%</span>
      <span class="fu">select</span>(-<span class="no">n</span>, -<span class="no">prop</span>) <span class="kw">%&gt;%</span>
      <span class="fu">spread</span>(!!<span class="no">group</span>, <span class="no">v1</span>)
  }
}</pre></body></html></div>
</div>
<div id="create-a-method-for-bds" class="section level3">
<h3 class="hasAnchor">
<a href="#create-a-method-for-bds" class="anchor"></a>Create a method for BDS</h3>
<p>We don’t need a method for BDS because we currently only import PARAMCD blocks and since AVAL and CHG are numeric we can’t calculate frequency:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">CDISC_freq.BDS</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">column</span>, <span class="no">week</span>, <span class="no">group</span> <span class="kw">=</span> <span class="kw">NULL</span>, <span class="no">data</span>) {
  <span class="kw pkg">rlang</span><span class="kw ns">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span>(<span class="kw pkg">glue</span><span class="kw ns">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(
    <span class="st">"Can't calculate frequency for BDS - {column} is numeric"</span>
  ))
}</pre></body></html></div>
<p>Feel free to explore the mean, ANOVA, and chg files for other statistical examples. For instance, blocks with BDS methods use the <code>week</code> argument which is supplied from the block’s dropdown.</p>
</div>
</div>
<div id="putting-it-all-together" class="section level1">
<h1 class="hasAnchor">
<a href="#putting-it-all-together" class="anchor"></a>Putting it all together</h1>
<p>Once you have your statistical function, you need to add it to the <code>CDISC_methods</code> function:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">CDISC_methods</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">agg</span>, <span class="no">column</span>, <span class="no">week</span>, <span class="no">group</span>, <span class="no">data</span>) {
  <span class="kw">if</span> (<span class="no">agg</span> <span class="kw">==</span> <span class="st">"MEAN"</span>) {
    <span class="fu"><a href="../reference/CDISC_mean.html">CDISC_mean</a></span>(<span class="no">column</span>, <span class="no">week</span>, <span class="no">group</span>, <span class="no">data</span>)
  } <span class="kw">else</span> <span class="kw">if</span> (<span class="no">agg</span> <span class="kw">==</span> <span class="st">"FREQ"</span>) {
    <span class="fu"><a href="../reference/CDISC_freq.html">CDISC_freq</a></span>(<span class="no">column</span>, <span class="no">week</span>, <span class="no">group</span>, <span class="no">data</span>)
  } <span class="kw">else</span> <span class="kw">if</span> (<span class="no">agg</span> <span class="kw">==</span> <span class="st">"ANOVA"</span>) {
    <span class="fu"><a href="../reference/CDISC_anova.html">CDISC_anova</a></span>(<span class="no">column</span>, <span class="no">week</span>, <span class="no">group</span>, <span class="no">data</span>)
  } <span class="kw">else</span> {
    <span class="fu"><a href="../reference/CDISC_chg.html">CDISC_chg</a></span>(<span class="no">column</span>, <span class="no">week</span>, <span class="no">group</span>, <span class="no">data</span>)
  }
}</pre></body></html></div>
<p>This function will look for the name of the dragged in statistical block and apply the correct statistical function based on the block’s name. Since the first argument of the function is the column to apply the statistical block on, it will look for the data file the column came from and choose the correct method.</p>
<p>Finally this function is used within a <code>map</code> in <code>mod_tableGen</code> so each statistical block is applied to each column in the drop zone iteratively.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Maya Gans, Aaron Clark, Robert Krajcik, Nate Mockler.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
